```
# Synthetic Video & Camera-Aware Trajectory Generator

Этот проект является форком оригинального репозитория [Poisson_blend](https://github.com/erkaman/Poisson_blend) и решает задачу генерации синтетических видео с динамической траекторией движения объекта, учитывающей движение камеры. Проект создан для обеспечения реалистичной вставки объекта в видео с адаптивной траекторией, которая корректируется в соответствии с перемещением камеры.

---

## Особенности проекта

- **Seamless Object Blending:** Естественная вставка объекта в кадры с использованием алгоритма Poisson blending.
- **Synthetic Trajectory Generation:** Генерация траектории объекта на основе ключевых кадров, заданных в текстовом файле.
- **Camera-Aware Trajectory Adjustment:** Корректировка траектории с учётом смещения и движения камеры.
- **Flexible Insertion Methods:** Поддержка двух методов вставки объекта – `poisson` (с Poisson blending) и `simple` (простая вставка).

---

## Структура проекта

```
.
├── build/                  # Директория для сборки C++ проекта
├── poisson_blend/          # Исходный код C++ оригинального Poisson_blend
├── simulate_trajectory.py  # Модуль для симуляции траектории
├── video_insert.py         # Модуль для вставки объекта в видео
├── input.txt               # Пример файла с ключевыми кадрами (формат: frame_number x y [s])
├── vids/                   # В эту папку необходимо поместить видео, на которое будет вставляться объект
├── save/                  # Папка, создаваемая автоматически для сохранения промежуточных файлов
├── res/                   # Директория для сохранения результатов обработки видео
├── requirements.txt        # Файл с зависимостями для Python
└── README.md               # Этот файл
```

---

## Сборка C++ инструмента Poisson Blending

Проект использует библиотеки [lodepng](https://github.com/lvandeve/lodepng) и [Eigen](http://eigen.tuxfamily.org/) для работы с изображениями и матрицами. Обе библиотеки включены в репозиторий.

### Инструкции по сборке на Linux

Откройте терминал и выполните следующие команды:

```
mkdir build && cd build
cmake ..
make
```

После успешной сборки в каталоге `build` появится исполняемый файл `poisson_blend`.

### Пример использования

```
./poisson_blend -source path/to/source.png -target path/to/target.png -mask path/to/mask.png -output result.png -mx 280 -my 340
```

Параметры:
- **-source** — путь к исходному изображению (объекту).
- **-target** — путь к целевому изображению.
- **-mask** — путь к изображению маски, определяющему область вставки.
- **-output** — путь для сохранения результата.
- **-mx, -my** — координаты вставки объекта.

---

## Работа с Python модулями

Проект включает два основных Python скрипта, обеспечивающих генерацию синтетических видео с корректировкой траектории.

### 1. Симуляция траектории (`simulate_trajectory.py`)

Данный модуль генерирует траекторию объекта на основе ключевых кадров, заданных в текстовом файле.

#### Формат файла с ключевыми кадрами (например, `input.txt`)
Каждая строка файла должна иметь следующий формат:
```
frame_number x_coordinate y_coordinate [s_coordinate]
```
- **frame_number** — номер кадра.
- **x_coordinate, y_coordinate** — координаты вставки.
- **s_coordinate** — (опционально) коэффициент масштабирования (по умолчанию 1.0).

Пример:
```
0 100 200 1.0
10 150 250 1.2
20 200 300 1.0
```

---

### 2. Вставка объекта в видео (`video_insert.py`)

Скрипт предназначен для вставки объекта в видео. Он выполняет следующие этапы:
1. Извлечение кадров из видео.
2. Анализ движения камеры.
3. Генерация траектории с помощью модуля `simulate_trajectory.py`.
4. Вставка объекта в кадры видео с использованием выбранного метода:
   - **poisson** — с использованием Poisson blending.
   - **simple** — простая вставка объекта.
5. Сборка итогового видео с заданной частотой кадров.

#### Использование скрипта

Запустите скрипт из терминала, передав необходимые аргументы:

```
python3 video_insert.py path/to/object.png path/to/mask.png --fps 15 --mask_method auto --insert_method poisson
```

Параметры:
- **path/to/object.png** — путь к изображению объекта для вставки.
- **path/to/mask.png** — путь к изображению маски (если используется режим `auto` для маски).
- **--fps** — частота кадров выходного видео (по умолчанию 15).
- **--mask_method** — метод получения маски:
  - `auto` — загрузить маску из файла.
  - `grab` — сгенерировать маску с помощью GrabCut.
- **--insert_method** — метод вставки:
  - `poisson` — использование Poisson blending.
  - `simple` — простая вставка объекта.

После обработки итоговое видео сохраняется в директории `res/`.

---

## Установка зависимостей

Для работы Python скриптов проект требует определённых пакетов. Все необходимые зависимости перечислены в файле `requirements.txt`.

Чтобы установить зависимости, выполните в терминале:

```
pip install -r requirements.txt
```

---

## Требования

### Для C++ части:
- CMake
- Компилятор C++ (gcc, clang и т.д.)

### Для Python скриптов:
- Python 3.x
- Зависимости, указанные в файле `requirements.txt`
```
