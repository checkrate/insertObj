Этот проект является форком оригинального репозитория [Poisson_blend](https://github.com/erkaman/Poisson_blend) и расширяет его возможности. Помимо стандартной функциональности seamless вставки изображения с использованием Poisson blending, добавлены два новых модуля:

- **simulate_trajectory.py** – симулирует траекторию объекта на основе ключевых кадров, считываемых из текстового файла.
- **video_insert.py** – обрабатывает видео: извлекает кадры, вычисляет движение камеры, симулирует траекторию и вставляет объект (с поддержкой двух методов вставки).

---

## Особенности проекта

- **Poisson Blending:** Seamless вставка объекта в целевое изображение с использованием алгоритма Poisson blending.
- **Симуляция траектории:** Возможность задания траектории через текстовый файл с ключевыми кадрами.
- **Обработка видео:** Извлечение кадров из видео, вычисление движения камеры, симуляция траектории и вставка объекта в каждый кадр.
- **Выбор метода вставки:** Поддерживаются два режима вставки объекта:
  - `poisson` – вставка с использованием Poisson blending.
  - `simple` – простая вставка без сложного смешивания.
- **Настраиваемые параметры:** Задавайте масштабирование, частоту кадров, методы генерации маски и вставки.

---

## Структура проекта

```
.
├── build/                  # Директория для сборки C++ проекта
├── poisson_blend/          # Исходный код C++ оригинального Poisson_blend
├── simulate_trajectory.py  # Модуль для симуляции траектории
├── video_insert.py         # Модуль для обработки видео и вставки объекта
├── input.txt               # Пример файла с ключевыми кадрами (формат: frame_number x y [s])
├── vids/                   # Директория с видеофайлами для обработки
├── res/                    # Директория для сохранения результатов обработки видео
├── requirements.txt        # Файл с зависимостями для Python
└── README.md               # Этот файл
```

---

## Сборка C++ инструмента Poisson Blending

Проект использует библиотеки [lodepng](https://github.com/lvandeve/lodepng) и [Eigen](http://eigen.tuxfamily.org/) для работы с изображениями и матрицами. Обе библиотеки включены в репозиторий.

### Инструкции по сборке на Linux

Откройте терминал и выполните следующие команды:

```
mkdir build && cd build
cmake ..
make
```

После успешной сборки в каталоге `build` появится исполняемый файл `poisson_blend`.

### Пример использования

```
./poisson_blend -source path/to/source.png -target path/to/target.png -mask path/to/mask.png -output result.png -mx 280 -my 340
```

Параметры:
- **-source** — путь к исходному изображению (объекту).
- **-target** — путь к целевому изображению.
- **-mask** — путь к изображению маски, определяющему область вставки.
- **-output** — путь для сохранения результата.
- **-mx, -my** — координаты вставки объекта.

---

## Работа с Python модулями

Проект включает два основных Python скрипта для расширения функционала:

### 1. Симуляция траектории (`simulate_trajectory.py`)

Этот модуль симулирует траекторию объекта на основе ключевых кадров, заданных в текстовом файле.

#### Формат файла с ключевыми кадрами (например, `input.txt`)
Каждая строка файла должна иметь следующий формат:
```
frame_number x_coordinate y_coordinate [s_coordinate]
```
- **frame_number** — номер кадра.
- **x_coordinate, y_coordinate** — координаты вставки.
- **s_coordinate** — (опционально) коэффициент масштабирования (по умолчанию 1.0).

Пример:
```
0 100 200 1.0
10 150 250 1.2
20 200 300 1.0
```
---

### 2. Обработка видео и вставка объекта (`video_insert.py`)

Скрипт предназначен для обработки видеофайлов, расположенных в директории `vids/`. Он выполняет следующие этапы:
1. Извлечение кадров из видео.
2. Вычисление движения камеры.
3. Симуляция траектории с помощью модуля `simulate_trajectory.py`.
4. Вставка объекта в кадры видео с использованием выбранного метода:
   - **poisson** – с использованием Poisson blending.
   - **simple** – простая вставка.
5. Сборка итогового видео с заданным числом кадров в секунду.

#### Использование скрипта

Запустите скрипт из терминала, передав необходимые аргументы:

```
python3 video_insert.py path/to/object.png path/to/mask.png --fps 15 --mask_method auto --insert_method poisson
```

Параметры:
- **path/to/object.png** — путь к изображению объекта для вставки.
- **path/to/mask.png** — путь к изображению маски (если используется режим `auto` для маски).
- **--fps** — частота кадров выходного видео (по умолчанию 15).
- **--mask_method** — метод получения маски:
  - `auto` — загрузить маску из файла.
  - `grab` — сгенерировать маску с помощью GrabCut.
- **--insert_method** — метод вставки:
  - `poisson` — использование Poisson blending.
  - `simple` — простая вставка объекта.

После обработки итоговое видео сохраняется в директории `res/`.

---

## Установка зависимостей

Для работы Python скриптов проект требует определённых пакетов. Все необходимые зависимости перечислены в файле `requirements.txt`.

Чтобы установить зависимости, выполните в терминале:

```
pip install -r requirements.txt
```

---

## Требования

### Для C++ части:
- CMake
- Компилятор C++ (gcc, clang и т.д.)

### Для Python скриптов:
- Python 3.x
- Зависимости, указанные в файле `requirements.txt`

---

## Демонстрация работы
